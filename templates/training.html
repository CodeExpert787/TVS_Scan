{% extends "base.html" %}

{% block title %}Model Training - PCOS Analysis System{% endblock %}

{% block extra_css %}
<style>
    .progress {
        height: 25px;
    }
    .progress-bar {
        transition: width 0.5s ease-in-out;
    }
    #trainingStatus {
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    #trainingStatus.visible {
        display: block;
        opacity: 1;
    }
    .btn-group {
        display: flex;
        gap: 10px;
    }
    #trainingResults {
        display: none;
    }
    .metrics-card {
        margin-top: 20px;
    }
    .metrics-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #6c5ce7;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Model Training</h1>

<!-- File Upload Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Upload Training Data</h5>
    </div>
    <div class="card-body">
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="trainingFile" class="form-label">Select Training Data File</label>
                <input type="file" class="form-control" id="trainingFile" name="file" accept=".docx,.csv,.xlsx">
            </div>
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>Upload File
                </button>
                <button type="button" id="startTrainingBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play me-2"></i>Start Training
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Training Status Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Training Status</h5>
    </div>
    <div class="card-body">
        <div id="trainingStatus">
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="statusText">Status: Idle</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div id="lastTrained" class="text-muted"></div>
        </div>
    </div>
</div>

<!-- Training Results Section -->
<div id="trainingResults" class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Training Results</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card metrics-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Training Accuracy</h6>
                        <p class="metrics-value" id="trainAccuracy">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card metrics-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Test Accuracy</h6>
                        <p class="metrics-value" id="testAccuracy">-</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-4">
            <h6>Classification Report</h6>
            <pre id="classificationReport" class="bg-light p-3 rounded"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to update training status
    function updateTrainingStatus() {
        fetch('/training-status')
            .then(response => response.json())
            .then(data => {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const statusText = document.getElementById('statusText');
                const startTrainingBtn = document.getElementById('startTrainingBtn');
                const lastTrained = document.getElementById('lastTrained');
                const trainingStatus = document.getElementById('trainingStatus');
                const trainingResults = document.getElementById('trainingResults');

                // Show training status section when training starts
                if (data.is_training && !trainingStatus.classList.contains('visible')) {
                    trainingStatus.classList.add('visible');
                }

                progressBar.style.width = `${data.progress}%`;
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressText.textContent = `${data.progress}%`;
                statusText.textContent = `Status: ${data.status}`;

                if (data.last_trained) {
                    const date = new Date(data.last_trained);
                    lastTrained.textContent = `Last trained: ${date.toLocaleString()}`;
                }

                startTrainingBtn.disabled = data.is_training;
                if (data.is_training) {
                    startTrainingBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Training in Progress...';
                } else {
                    startTrainingBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start Training';
                }

                // Show results when training is completed
                if (data.status === 'completed' && data.metrics) {
                    trainingResults.style.display = 'block';
                    document.getElementById('trainAccuracy').textContent = 
                        `${(data.metrics.train_accuracy * 100).toFixed(2)}%`;
                    document.getElementById('testAccuracy').textContent = 
                        `${(data.metrics.accuracy * 100).toFixed(2)}%`;
                    
                    // Format and display classification report
                    const report = data.metrics.classification_report;
                    let reportText = '';
                    for (const [label, metrics] of Object.entries(report)) {
                        if (label !== 'accuracy') {
                            reportText += `Class ${label}:\n`;
                            reportText += `  Precision: ${(metrics.precision * 100).toFixed(2)}%\n`;
                            reportText += `  Recall: ${(metrics.recall * 100).toFixed(2)}%\n`;
                            reportText += `  F1-score: ${(metrics.f1_score * 100).toFixed(2)}%\n`;
                            reportText += `  Support: ${metrics.support}\n\n`;
                        }
                    }
                    document.getElementById('classificationReport').textContent = reportText;
                }

                if (data.is_training) {
                    setTimeout(updateTrainingStatus, 1000);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Handle file upload
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('trainingFile');
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload-training-data', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert('File uploaded successfully!');
            document.getElementById('startTrainingBtn').disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading file');
        });
    });

    // Handle start training
    document.getElementById('startTrainingBtn').addEventListener('click', function() {
        fetch('/start-training', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            // Show training status section immediately when training starts
            const trainingStatus = document.getElementById('trainingStatus');
            trainingStatus.classList.add('visible');
            updateTrainingStatus();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting training');
        });
    });

    // Initial status update
    updateTrainingStatus();
</script>
{% endblock %} 