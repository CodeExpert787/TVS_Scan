{% extends "base.html" %}

{% block title %}Analyze PCOS - PCOS Analysis Platform{% endblock %}

{% block extra_css %}
<style>
    .analyze-section {
        transition: var(--transition);
    }
    .analyze-section:hover {
        transform: translateY(-5px);
    }
    .form-label {
        font-weight: 500;
        color: var(--text-color);
    }
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }
    .required-field::after {
        content: " *";
        color: var(--danger-color);
    }
    .error-message {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    .submit-section {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    .progress-bar {
        height: 5px;
        transition: width 0.3s ease;
    }
    .question-card {
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: var(--transition);
    }
    .question-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .question-number {
        font-weight: bold;
        color: var(--primary-color);
        margin-right: 0.5rem;
    }
    .question-text {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    .input-group {
        margin-bottom: 0.5rem;
    }
    .input-group-text {
        background-color: var(--light-bg);
        border-color: var(--border-color);
    }
    .form-control {
        border-color: var(--border-color);
    }
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
    }
    .result-section {
        margin-top: 2rem;
    }
    .result-card {
        transition: var(--transition);
    }
    .result-card:hover {
        transform: translateY(-5px);
    }
    .confidence-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <h2 class="h4 mb-0"><i class="fas fa-microscope me-2"></i>PCOS Analysis</h2>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
    </div>
    {% endif %}

    {% if prediction %}
    <div class="row result-section">
        <div class="col-12">
            <div class="card shadow result-card">
                <div class="card-header">
                    <h3 class="h5 mb-0"><i class="fas fa-chart-pie me-2"></i>Analysis Results</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="h6 mb-3">Prediction</h4>
                            <div class="d-flex align-items-center">
                                <h5 class="mb-0 {% if prediction == 'PCOS' %}text-danger{% else %}text-success{% endif %}">
                                    {{ prediction }}
                                </h5>
                                <span class="badge bg-light text-dark confidence-badge ms-3">
                                    Confidence: {{ "%.2f"|format(confidence) }}%
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h6 mb-3">Recommendations</h4>
                            <ul class="list-group list-group-flush">
                                {% if prediction == 'PCOS' %}
                                <li class="list-group-item">Consult with a healthcare provider for proper diagnosis and treatment</li>
                                <li class="list-group-item">Consider lifestyle modifications including diet and exercise</li>
                                <li class="list-group-item">Monitor symptoms and maintain regular check-ups</li>
                                {% else %}
                                <li class="list-group-item">Maintain a healthy lifestyle with balanced diet and regular exercise</li>
                                <li class="list-group-item">Continue regular health check-ups</li>
                                <li class="list-group-item">Monitor for any changes in symptoms</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="analyzeForm" method="POST" class="analyze-section">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h3 class="h5 mb-0"><i class="fas fa-question-circle me-2"></i>Please answer all questions</h3>
                    </div>
                    <div class="card-body">
                        <!-- Progress Bar -->
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>

                        <!-- Questions Container -->
                        <div id="questionsContainer">
                            {% for question in questions %}
                            <div class="question-card" data-question="{{ loop.index }}">
                                <div class="question-text">
                                    <span class="question-number">Q{{ loop.index }}.</span>
                                    {{ question }}
                                </div>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           name="{{ question }}" 
                                           id="{{ question }}_input" 
                                           required 
                                           placeholder="Enter value">
                                    <div class="error-message" style="display: none;"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Submit Section -->
                        <div class="submit-section sticky-bottom bg-white py-3">
                            <div class="container d-flex justify-content-between align-items-center">
                                <div class="progress-container">
                                    <div class="progress" role="progressbar" aria-label="Analysis progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 250px;">
                                        <div class="progress-bar" style="width: 0%"></div>
                                    </div>
                                    <span id="progress-text" class="ms-2">0/{{ questions|length }} Answered</span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary me-2" id="randomBtn">Generate Random Input</button>
                                    <button type="button" class="btn btn-danger me-2" id="resetBtn">Reset Form</button>
                                    <button type="submit" class="btn btn-primary" id="analyzeBtn">Analyze</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const totalQuestions = {{ questions|length }};
        let answeredQuestions = 0;
        const progressBar = document.querySelector('.progress-bar');
        const progressText = document.getElementById('progress-text');
        const errorMessages = document.getElementById('error-messages');
        const analyzeForm = document.getElementById('analyzeForm');
        const randomBtn = document.getElementById('randomBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Function to update progress
        function updateProgress() {
            const progress = (answeredQuestions / totalQuestions) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = `${answeredQuestions}/${totalQuestions} Answered`;
            // Update analyze button state
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.disabled = answeredQuestions !== totalQuestions;
            }
        }

        // Handle random input button
        randomBtn.addEventListener('click', async function() {
            try {
                // Show loading state
                randomBtn.disabled = true;
                randomBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                
                // Fetch random data
                const response = await fetch('/analyze/random-data');
                const result = await response.json();
                
                if (result.success) {
                    // Fill all input fields with random data
                    document.querySelectorAll('input[type="text"]').forEach(function(input) {
                        const questionName = input.getAttribute('name');
                        const value = result.data[questionName];
                        
                        if (value !== undefined) {
                            input.value = value;
                            
                            // Update answered status
                            const questionCard = input.closest('.question-card');
                            if (!questionCard.dataset.answered) {
                                answeredQuestions++;
                                questionCard.dataset.answered = 'true';
                            }
                        }
                    });
                    
                    // Update progress
                    updateProgress();
                    
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>Random data loaded successfully
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.card-body').insertBefore(alert, document.querySelector('.progress'));
                    
                    // Auto-dismiss alert after 3 seconds
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                // Show error message
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.card-body').insertBefore(alert, document.querySelector('.progress'));
            } finally {
                // Reset button state
                randomBtn.disabled = false;
                randomBtn.innerHTML = '<i class="fas fa-random me-2"></i>Generate Random Input';
            }
        });

        // Reset button functionality
        resetBtn.addEventListener('click', function() {
            analyzeForm.reset(); // Reset the form fields
            updateProgress(); // Update the progress bar and text
            if (errorMessages) {
                errorMessages.innerHTML = ''; // Clear any error messages
            }
             // Clear input field validity states (Bootstrap validation classes)
            analyzeForm.querySelectorAll('.form-control').forEach(input => {
                input.classList.remove('is-valid', 'is-invalid');
            });
        });

        // Initial progress update
        updateProgress();

        // Event listener for form submission (existing)
        analyzeForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Validate all questions are answered
            let allAnswered = true;
            document.querySelectorAll('.question-card').forEach(function(card) {
                const input = card.querySelector('input[type="text"]');
                const value = input.value.trim();
                
                if (value === '') {
                    allAnswered = false;
                    const errorMessage = card.querySelector('.error-message');
                    errorMessage.textContent = 'Please enter a value';
                    errorMessage.style.display = 'block';
                }
            });
            
            if (allAnswered) {
                // Show loading state
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) {
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
                }
                
                // Submit the form
                analyzeForm.submit();
            } else {
                // Scroll to first unanswered question
                const firstError = document.querySelector('.error-message[style="display: block"]');
                if (firstError) {
                    firstError.closest('.question-card').scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        });

        // Handle input changes
        document.querySelectorAll('input[type="text"]').forEach(function(input) {
            input.addEventListener('input', function() {
                const questionCard = this.closest('.question-card');
                const questionName = this.getAttribute('name');
                
                // Check if this is the first answer for this question
                if (!questionCard.dataset.answered && this.value.trim() !== '') {
                    answeredQuestions++;
                    questionCard.dataset.answered = 'true';
                } else if (questionCard.dataset.answered && this.value.trim() === '') {
                    answeredQuestions--;
                    questionCard.dataset.answered = '';
                }
                
                // Remove error message if it exists
                const errorMessage = questionCard.querySelector('.error-message');
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
                
                updateProgress();
            });
        });
    });
</script>
{% endblock %} 